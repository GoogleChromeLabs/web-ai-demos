<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tagesschau Aktuell</title>
    <style>
      :root {
        color-scheme: dark light;
        --primary-color: #003366;
        --secondary-color: #ffffff;
        --text-color: #333333;
        --border-color: #eeeeee;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --font-family:
          system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Helvetica, Arial, sans-serif;
      }

      body {
        font-family: var(--font-family);
        margin: 0;
        background-color: #f4f4f9;
        color: var(--text-color);
      }

      body.modal-open {
        overflow: hidden;
      }

      header {
        background-color: var(--primary-color);
        color: var(--secondary-color);
        padding: 1.5rem;
        text-align: center;
        font-size: 1.8rem;
        font-weight: bold;
        box-shadow: 0 2px 4px var(--shadow-color);
      }

      .page-container {
        display: flex;
        flex-direction: column;
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
      }

      main {
        flex-grow: 1;
      }

      #news-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
      }

      /* Sidebar Styling */
      .sidebar {
        padding: 1rem;
        background-color: var(--secondary-color);
        border-radius: 8px;
        box-shadow: 0 4px 8px var(--shadow-color);
        margin-top: 1.5rem;
      }

      .sidebar h2 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
      }

      #reading-log-list,
      #recommendations-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #reading-log-list {
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 1rem;
      }

      #reading-log-list li,
      #recommendations-list li {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      #reading-log-list li:last-child,
      #recommendations-list li:last-child {
        border-bottom: none;
      }

      #reading-log-list a {
        text-decoration: none;
        color: var(--primary-color);
        font-weight: 500;
        cursor: pointer;
      }

      #reading-log-list a:hover {
        text-decoration: underline;
      }

      .recommendation-item a {
        font-weight: bold;
        color: var(--primary-color);
        cursor: pointer;
      }
      .recommendation-item p {
        font-size: 0.9em;
        color: #555;
        margin: 0.5rem 0 0 0;
        font-style: italic;
      }

      .empty-log-message {
        color: #777;
        font-style: italic;
      }

      #recommendations-container {
        margin-top: 1.5rem;
      }

      #recommend-button {
        width: 100%;
        padding: 0.8rem;
        font-weight: bold;
        font-size: 1rem;
        background-color: #007a5e;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 1rem;
      }

      #recommend-button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }

      #recommend-status {
        font-style: italic;
        color: #555;
        margin-top: 0.5rem;
        text-align: center;
      }

      progress[hidden] ~ label {
        display: none;
      }

      /* Desktop Layout with Sidebar */
      @media (min-width: 992px) {
        .page-container {
          flex-direction: row;
          gap: 1.5rem;
          align-items: flex-start;
        }
        .sidebar-wrapper {
          width: 320px;
          flex-shrink: 0;
          position: sticky;
          top: 1.5rem;
        }
        .sidebar {
          margin-top: 0;
        }
      }

      .news-card {
        background-color: var(--secondary-color);
        border-radius: 8px;
        box-shadow: 0 4px 8px var(--shadow-color);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease-in-out;
      }

      .news-card:hover {
        transform: translateY(-5px);
      }
      .news-card__image-container {
        width: 100%;
        padding-top: 56.25%;
        position: relative;
        background-color: var(--border-color);
      }
      .news-card__image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-bottom: 1px solid var(--border-color);
      }
      .news-card__type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 51, 102, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        text-transform: capitalize;
      }
      .news-card__content {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      .news-card__topline {
        font-size: 0.8rem;
        font-weight: bold;
        color: #555;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }
      .news-card__title {
        font-size: 1.25rem;
        font-weight: bold;
        margin: 0 0 0.5rem 0;
      }
      .news-card__date {
        font-size: 0.8rem;
        color: #777;
        margin-bottom: 1rem;
      }
      .news-card__teaser {
        font-size: 0.95rem;
        line-height: 1.5;
        flex-grow: 1;
      }
      .news-card__button {
        display: inline-block;
        margin-top: 1rem;
        padding: 0.6rem 1rem;
        background-color: var(--primary-color);
        color: var(--secondary-color);
        text-decoration: none;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
        width: 100%;
      }
      .news-card__button:hover {
        background-color: #0055a4;
      }
      #loading,
      #error {
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.3s,
          visibility 0.3s;
        z-index: 1000;
      }
      .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
      }
      .modal-container {
        background: var(--secondary-color);
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        transform: translateY(-50px);
        transition: transform 0.3s;
      }
      .modal-overlay.visible .modal-container {
        transform: translateY(0);
      }
      .modal-close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #888;
      }
      .modal-content p,
      .modal-content div {
        line-height: 1.6;
      }
      .modal-content h1,
      .modal-content h2,
      .modal-content h3 {
        font-size: 1.5rem;
      }
      .content-box {
        border: 1px solid var(--border-color);
        background-color: #f9f9f9;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
      }
      .content-box h4 {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <header>Tagesschau Aktuell</header>

    <div class="page-container">
      <main>
        <div id="news-container">
          <div id="loading">Lade Nachrichten...</div>
        </div>
      </main>

      <div class="sidebar-wrapper">
        <aside id="reading-log" class="sidebar">
          <h2>Leseliste (Aktuelle Sitzung)</h2>
          <ul id="reading-log-list"></ul>
        </aside>
        <aside id="recommendations-container" class="sidebar">
          <h2>KI-Empfehlungen</h2>
          <progress
            hidden
            id="progress"
            value="0"
            style="width: 100%"
          ></progress>
          <label for="progress">Modelldownload...</label>
          <div id="recommend-status">
            Lesen Sie mindestens 3 Artikel, um Empfehlungen zu erhalten.
          </div>
          <ul id="recommendations-list"></ul>
          <button id="recommend-button" disabled>
            Empfehlungen generieren
          </button>
        </aside>
      </div>
    </div>

    <div id="article-modal" class="modal-overlay">
      <div class="modal-container">
        <button id="modal-close" class="modal-close-button">&times;</button>
        <div id="modal-content" class="modal-content"></div>
      </div>
    </div>

    <script>
      // --- DOM Elements ---
      const newsContainer = document.getElementById('news-container');
      const readingLogList = document.getElementById('reading-log-list');
      const recommendationsList = document.getElementById(
        'recommendations-list'
      );
      const recommendButton = document.getElementById('recommend-button');
      const recommendStatus = document.getElementById('recommend-status');
      const modal = document.getElementById('article-modal');
      const modalContent = document.getElementById('modal-content');
      const modalCloseBtn = document.getElementById('modal-close');
      const progress = document.querySelector('progress');

      // --- State and Constants ---
      const API_URL = 'https://www.tagesschau.de/api2u/homepage/';
      const API_URL_FALLBACK = 'news.json';
      const READING_LOG_KEY = 'tagesschauReadingLog';
      let languageModelSession = null;
      let sessionCreationTriggered = false;
      let displayedArticles = []; // Cache for all currently shown articles

      // --- Core News App Functions ---

      async function main() {
        updateReadingLogDisplay();
        await fetchNews();
      }

      async function fetchNews() {
        // First attempt: Try to fetch from the primary API_URL
        try {
          const response = await fetch(API_URL);
          if (!response.ok) {
            // If the server responds with an error (like 404 or 500), throw an error to trigger the catch block.
            throw new Error(
              `Primary API failed with status: ${response.status}`
            );
          }
          const data = await response.json();
          displayNews(data.news);
        } catch (primaryError) {
          // This block is executed if the first fetch fails for any reason (network error, server error, etc.).
          console.error(
            'Primary API fetch failed, trying fallback...',
            primaryError
          );

          // Second attempt: Try to fetch from the fallback URL
          try {
            const fallbackResponse = await fetch(API_URL_FALLBACK);
            if (!fallbackResponse.ok) {
              // If the fallback also gives a bad response, throw an error to trigger the final catch block.
              throw new Error(
                `Fallback API failed with status: ${fallbackResponse.status}`
              );
            }
            const fallbackData = await fallbackResponse.json();
            displayNews(fallbackData.news);
          } catch (fallbackError) {
            // This block is executed only if BOTH the primary and fallback attempts have failed.
            console.error('Fallback API fetch also failed:', fallbackError);
            displayError('Nachrichten-Feed konnte nicht geladen werden.');
          }
        }
      }

      function displayNews(newsItems) {
        newsContainer.innerHTML = '';

        const filteredNews = newsItems.filter(
          (item) => item.firstSentence && item.details
        );
        displayedArticles = filteredNews; // Store articles for later use by the recommender

        if (filteredNews.length === 0) {
          displayError('Keine Artikel mit Vorschau gefunden.');
          return;
        }

        filteredNews.forEach((article) => {
          article.title = article.title.replace(/"/g, '&quot;');
          article.firstSentence = article.firstSentence.replace(/"/g, '&quot;');
          const imageUrl =
            article.teaserImage?.imageVariants?.['16x9-640'] || '';
          let formattedDate = '';
          if (article.date) {
            try {
              const date = new Date(article.date);
              formattedDate =
                date.toLocaleString('de-DE', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                }) + ' Uhr';
            } catch (e) {
              console.warn(
                'Datum konnte nicht verarbeitet werden:',
                article.date
              );
            }
          }

          const card = document.createElement('article');
          card.className = 'news-card';

          card.innerHTML = `
            <div class="news-card__image-container">
              <img src="${imageUrl}" alt="${article.teaserImage?.alttext || article.title}" loading="lazy" class="news-card__image">
              <span class="news-card__type-badge">${article.type || 'News'}</span>
            </div>
            <div class="news-card__content">
              ${article.topline ? `<h3 class="news-card__topline">${article.topline}</h3>` : ''}
              <h2 class="news-card__title">${article.title}</h2>
              <p class="news-card__date">${formattedDate}</p>
              <p class="news-card__teaser">${article.firstSentence}</p>
              <button class="news-card__button"
                  data-details-url="${article.details}"
                  data-id="${article.sophoraId}"
                  data-title="${article.title}"
                  data-first-sentence="${article.firstSentence}"
              >
                Weiterlesen
              </button>
            </div>`;
          newsContainer.appendChild(card);
        });
      }

      async function fetchArticleDetails(url) {
        showModal('<div id="loading">Lade Artikel...</div>');
        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const articleData = await response.json();

          let fullArticleHtml = '';
          if (articleData.content && Array.isArray(articleData.content)) {
            articleData.content.forEach((contentBlock) => {
              if (contentBlock.value) {
                fullArticleHtml += `<p>${contentBlock.value}</p>`;
              } else if (contentBlock.box && contentBlock.box.text) {
                fullArticleHtml += `<div class="content-box"><h4>${contentBlock.box.title || ''}</h4><div>${contentBlock.box.text}</div></div>`;
              }
            });
          }

          const finalModalHTML = `
            <h1>${articleData.title || 'Ohne Titel'}</h1>
            <p><strong>${articleData.topline || ''}</strong></p>
            <hr>
            <div>${fullArticleHtml || '<p>Der vollständige Artikelinhalt konnte nicht geladen werden.</p>'}</div>`;
          modalContent.innerHTML = finalModalHTML;
        } catch (error) {
          console.error('Failed to fetch article details:', error);
          modalContent.innerHTML =
            '<div id="error">Entschuldigung, der vollständige Artikel konnte nicht geladen werden.</div>';
        }
      }

      // --- Reading Log Functions ---

      function logArticleRead(articleInfo) {
        const log = JSON.parse(sessionStorage.getItem(READING_LOG_KEY) || '[]');
        const isAlreadyLogged = log.some((item) => item.id === articleInfo.id);

        if (!isAlreadyLogged) {
          log.unshift(articleInfo);
          sessionStorage.setItem(READING_LOG_KEY, JSON.stringify(log));
          updateReadingLogDisplay();
        }
      }

      function updateReadingLogDisplay() {
        const log = JSON.parse(sessionStorage.getItem(READING_LOG_KEY) || '[]');
        if (log.length === 0) {
          readingLogList.innerHTML =
            '<li><span class="empty-log-message">Sie haben noch keine Artikel gelesen.</span></li>';
          recommendButton.disabled = true;
          recommendStatus.textContent =
            'Lesen Sie mindestens 3 Artikel, um Empfehlungen zu erhalten.';
          return;
        }

        readingLogList.innerHTML = log
          .map(
            (item) => `
              <li>
                <a data-details-url="${item.url}" data-id="${item.id}" data-title="${item.title}">${item.title}</a>
              </li>`
          )
          .join('');

        if (log.length >= 3) {
          recommendButton.disabled = false;
          recommendStatus.textContent = 'Bereit für Empfehlungen!';
        } else {
          recommendButton.disabled = true;
          recommendStatus.textContent = `Lesen Sie noch ${3 - log.length} Artikel.`;
        }
      }

      // --- Language Model (AI Recommendation) Functions ---

      const createSession = async (options = {}) => {
        if (sessionCreationTriggered) return;
        progress.hidden = true;
        progress.value = 0;

        try {
          if (!('LanguageModel' in self)) {
            throw new Error(
              'Die Prompt API wird von Ihrem Browser nicht unterstützt. Bitte aktivieren Sie chrome://flags/#prompt-api in Chrome 127+.'
            );
          }
          const availability = await LanguageModel.availability();
          if (availability === 'unavailable') {
            throw new Error(
              'Das Sprachmodell ist auf diesem Gerät nicht verfügbar.'
            );
          }

          let modelNewlyDownloaded = availability !== 'available';
          if (modelNewlyDownloaded) progress.hidden = false;

          sessionCreationTriggered = true;
          const session = await LanguageModel.create({
            monitor(m) {
              m.addEventListener('downloadprogress', (e) => {
                progress.value = e.loaded;
                if (modelNewlyDownloaded && e.loaded === 1) {
                  progress.removeAttribute('value'); // Indeterminate state while loading
                }
              });
            },
            ...options,
          });
          sessionCreationTriggered = false;
          return session;
        } catch (error) {
          sessionCreationTriggered = false;
          throw error;
        } finally {
          progress.hidden = true;
          progress.value = 0;
        }
      };

      async function getRecommendations() {
        recommendButton.disabled = true;
        recommendStatus.textContent = 'Analysiere Artikel...';
        recommendationsList.innerHTML = '';

        const readArticlesLog = JSON.parse(
          sessionStorage.getItem(READING_LOG_KEY) || '[]'
        );
        if (readArticlesLog.length < 3) return;

        try {
          // 1. Get read and unread articles from the cached list
          const readArticleIDs = new Set(
            readArticlesLog.map((article) => article.id)
          );
          const unreadArticles = displayedArticles.filter(
            (article) => !readArticleIDs.has(article.sophoraId)
          );

          if (unreadArticles.length < 3) {
            recommendStatus.textContent =
              'Nicht genügend ungelesene Artikel für Empfehlungen.';
            recommendButton.disabled = false;
            return;
          }

          // 2. Build the system prompt with UNREAD article teasers
          let systemPromptContent =
            'Du bist ein Nachrichten-Redakteur. Deine Aufgabe ist es, aus der folgenden Liste verfügbarer Artikel, passende Empfehlungen für einen Nutzer zu generieren, basierend auf bisher gelesenen Artikeln. Gib für jede Empfehlung eine sehr kurze Begründung an, bezugnehmend auf die bereits gelesenen Artikel. Die verfügbaren Artikel sind:\n\n';
          unreadArticles.forEach((article) => {
            systemPromptContent += `---\nTitel: ${article.title}\nTeaser: ${article.firstSentence}\nID: ${article.sophoraId}\n---\n\n`;
          });

          // 3. Create the dynamic JSON Schema based on UNREAD articles
          const schema = {
            type: 'object',
            properties: {
              recommendations: {
                type: 'array',
                minItems: 1,
                items: {
                  type: 'object',
                  properties: {
                    id: {
                      type: 'string',
                      enum: unreadArticles.map((a) => a.sophoraId),
                    },
                    rationale: {
                      type: 'string',
                    },
                  },
                  required: ['id', 'rationale'],
                },
              },
            },
            required: ['recommendations'],
          };

          console.log('JSON Schema:', schema);

          // 4. Build the user prompt with READ article titles
          let userPromptContent =
            'Bitte empfiehl mir 3 neue, thematisch passende Artikel aus der Liste, die du bereits hast. Empfiehl mir ausdrücklich keine Artikel, die ich schon gelesen habe. Ich habe die folgenden Artikel schon gelesen:\n\n';
          readArticlesLog.forEach((article) => {
            userPromptContent += `---\nTitel: ${article.title}\nTeaser: ${article.firstSentence}\nID: ${article.id}\n---\n\n`;
          });

          userPromptContent += `\n\nBeispiel für eine Antwort:

{
  "recommendations": [
    {
      "id": "Eine Artikel-ID",
      "rationale": "Eine kurze Beschreibung"
    },
    {
      "id": "Eine Artikel-ID",
      "rationale": "Eine kurze Beschreibung"
    }
  ]
}`;

          // 5. Create session and prompt
          recommendStatus.textContent =
            'Initialisiere KI-Sitzung (kann dauern)...';
          languageModelSession = await createSession({
            initialPrompts: [{ role: 'system', content: systemPromptContent }],
          });
          console.log('System prompt:', {
            initialPrompts: [{ role: 'system', content: systemPromptContent }],
          });
          console.log('User prompt:', userPromptContent);
          recommendStatus.textContent = 'Generiere Empfehlungen...';
          const stream = languageModelSession.promptStreaming(
            userPromptContent,
            {
              responseConstraint: { schema },
              omitResponseConstraintInput: false,
            }
          );
          let result = '';
          for await (const chunk of stream) {
            result += chunk;
          }
          console.log('AI response:', result);
          const { recommendations } = JSON.parse(result);

          // 6. Display results
          displayRecommendations(recommendations, unreadArticles);
          recommendStatus.textContent = 'Hier sind Ihre Empfehlungen:';
        } catch (error) {
          console.error('Recommendation failed:', error);
          recommendStatus.textContent = 'Fehler bei der Empfehlung.';
          recommendationsList.innerHTML = `<li>Fehler: ${error.message}</li>`;
        } finally {
          if (readArticlesLog.length >= 3) recommendButton.disabled = false;
        }
      }

      function displayRecommendations(recommendations, unreadArticles) {
        console.log('Recommendations:', recommendations);
        recommendationsList.innerHTML = recommendations
          .map((rec) => {
            const originalArticle = unreadArticles.find(
              (item) => item.sophoraId === rec.id
            );
            if (!originalArticle) return '';
            return `
              <li class="recommendation-item">
                <a data-details-url="${originalArticle.details}" data-id="${originalArticle.sophoraId}" data-title="${originalArticle.title}">
                  ${originalArticle.title}
                </a>
                <p>Begründung: ${rec.rationale}</p>
              </li>`;
          })
          .join('');
      }

      // --- UI Helper Functions ---
      function showModal(content = '') {
        document.body.classList.add('modal-open');
        modalContent.innerHTML = content;
        modal.classList.add('visible');
      }
      function closeModal() {
        document.body.classList.remove('modal-open');
        modal.classList.remove('visible');
        modalContent.innerHTML = '';
      }
      function displayError(message) {
        newsContainer.innerHTML = `<div id="error">${message}</div>`;
      }

      // --- Event Listeners ---
      document.body.addEventListener('click', (event) => {
        const clickableItem = event.target.closest('[data-details-url]');
        if (clickableItem) {
          const articleInfo = {
            id: clickableItem.dataset.id,
            title: clickableItem.dataset.title,
            firstSentence: clickableItem.dataset.firstSentence,
            url: clickableItem.dataset.detailsUrl,
          };
          if (
            articleInfo.id &&
            articleInfo.title &&
            articleInfo.firstSentence &&
            articleInfo.url
          ) {
            fetchArticleDetails(articleInfo.url);
            logArticleRead(articleInfo);
          }
        }
      });

      recommendButton.addEventListener('click', getRecommendations);

      modalCloseBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal();
      });

      // --- Initial Load ---
      main();
    </script>
  </body>
</html>
